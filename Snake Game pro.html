<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Game</title>
    <style>
        body {
            background-color: #2c3e50;
            color: #ecf0f1;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            /* Add these for better background image handling */
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Optional, but nice */
            transition: background-image 0.5s ease-in-out; /* Smooth transition */
        }

        h1 {
            font-size: 3rem;
            letter-spacing: 5px;
        }

        #top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 600px;
            padding: 0 20px;
            position: absolute;
            top: 10px;
        }

        #auth-container button, #user-display button {
            background-color: transparent;
            color: #ecf0f1;
            border: 2px solid #7f8c8d;
            padding: 5px 15px;
            font-size: 0.9rem;
            font-family: 'Courier New', Courier, monospace;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.3s, color 0.3s;
            border-radius: 4px;
        }

        #auth-container button:hover, #user-display button:hover {
            background-color: #ecf0f1;
            color: #2c3e50;
        }

        #logoutButton {
            border-color: #e74c3c;
        }
        #logoutButton:hover {
            background-color: #e74c3c;
        }

        #profilePic {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #ecf0f1;
            margin-right: 10px;
            object-fit: cover; /* Prevents image distortion */
        }

        #score-container {
            display: flex;
            justify-content: space-around;
            width: 600px;
            margin-bottom: 1rem;
        }

        #score, #highScore {
            font-size: 1.2rem;
            flex-basis: 50%;
            text-align: center;
            padding: 5px;
        }

        canvas {
            border: 3px solid #ecf0f1;
            box-shadow: 0 0 20px #ecf0f1;
        }

        #retryButton {
            background-color: #e74c3c;
            color: #ecf0f1;
            border: 2px solid #ecf0f1;
            padding: 10px 20px;
            font-size: 1rem;
            font-family: 'Courier New', Courier, monospace;
            cursor: pointer;
            margin-top: 1rem;
            transition: background-color 0.3s, transform 0.3s;
        }

        #retryButton:hover {
            background-color: #c0392b;
            transform: scale(1.05);
        }

        #settingsButton {
            background-color: #3498db;
            color: #ecf0f1;
            border: 2px solid #ecf0f1;
            padding: 10px 20px;
            font-size: 1rem;
            font-family: 'Courier New', Courier, monospace;
            cursor: pointer;
            margin-top: 1rem;
            transition: background-color 0.3s, transform 0.3s;
        }

        #settingsButton:hover {
            background-color: #2980b9;
            transform: scale(1.05);
        }

        #pauseResumeButton {
            background-color: #f1c40f;
            color: #2c3e50;
            border: 2px solid #ecf0f1;
            padding: 10px 20px;
            font-size: 1rem;
            font-family: 'Courier New', Courier, monospace;
            cursor: pointer;
            margin-top: 1rem;
            transition: background-color 0.3s, color 0.3s, transform 0.3s;
        }

        #pauseResumeButton:hover {
            background-color: #f39c12;
            transform: scale(1.05);
        }

        .modal h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .setting-option {
            margin-bottom: 20px;
        }

        #speed-controls button {
            background-color: #555;
            color: #ecf0f1;
            border: 2px solid #777;
            padding: 8px 16px;
            font-size: 1rem;
            font-family: 'Courier New', Courier, monospace;
            cursor: pointer;
            margin: 0 5px;
            transition: background-color 0.3s;
        }

        #speed-controls button:hover {
            background-color: #777;
        }

        #speed-controls button.active {
            background-color: #27ae60; /* Green to indicate active */
            border-color: #2ecc71;
        }

        #graphics-controls, #background-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }

        #graphics-controls button, #background-controls button {
            background-color: #555;
            color: #ecf0f1;
            border: 2px solid #777;
            padding: 8px 16px;
            font-size: 1rem;
            font-family: 'Courier New', Courier, monospace;
            cursor: pointer;
            margin: 3px 5px;
            transition: background-color 0.3s;
        }

        #graphics-controls button:hover, #background-controls button:hover {
            background-color: #777;
        }

        #graphics-controls button.active {
            background-color: #3498db;
            border-color: #3498db;
        }

        #background-controls button.active {
            background-color: #e67e22;
            /* Orange */
            border-color: #d35400;
        }

        #applyCustomBgBtn {
            margin-left: 10px;
            padding: 10px;
            background-color: #e67e22;
            color: #ecf0f1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        #applyCustomBgBtn:hover {
            background-color: #d35400;
        }


        .hidden {
            display: none;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #34495e;
            padding: 20px 40px;
            border: 4px solid #ecf0f1;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            z-index: 1000;
            text-align: center;
        }

        /* Add a modern, transparent effect to auth modals */
        #loginModal, #signupModal {
            background-color: rgba(52, 73, 94, 0.8); /* Semi-transparent version of #34495e */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px); /* For Safari */
            border-radius: 10px; /* Optional: for a softer look */
            border: 2px solid rgba(236, 240, 241, 0.5);
            width: 700px; /* Increased width again */
            padding: 50px 70px; /* Increased padding again */
            box-sizing: border-box; /* Ensure padding is included in width */
        }

        .modal input {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 12px auto;
            font-family: 'Courier New', Courier, monospace;
            background-color: #1c2833;
            color: #ecf0f1;
            border: 2px solid #7f8c8d;
            border-radius: 4px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .modal input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px #3498db;
        }

        /* General styles for all modal buttons */
        .modal button {
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1rem;
            border-radius: 4px;
        }

        /* Specific styles for button types */
        .modal .btn-primary {
            background-color: #27ae60; /* Green for submit/action */
            color: #ecf0f1;
        }
        .modal .btn-primary:hover {
            background-color: #2ecc71;
        }

        .modal .btn-secondary {
            background-color: #7f8c8d; /* Grey for close/cancel */
            color: #ecf0f1;
        }
        .modal .btn-secondary:hover {
            background-color: #95a5a6;
        }

        .modal .btn-danger {
            background-color: #e74c3c; /* Red for destructive action */
            color: #ecf0f1;
        }

        .modal .btn-danger:hover {
            background-color: #c0392b;
        }

        #login-user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            border: 1px solid #7f8c8d;
            border-radius: 20px;
            padding: 5px 10px;
            cursor: pointer;
        }

        #login-user-info img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 10px;
        }

        #saveProfilePicBtn {
            margin-left: 10px;
            padding: 10px;
            background-color: #8e44ad;
            /* Amethyst */
            color: #ecf0f1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        #saveProfilePicBtn:hover {
            background-color: #9b59b6;
        }

        .modal form > div {
            margin-top: 20px;
        }

        .input-with-button {
            display: flex;
            align-items: center;
            width: 100%;
            margin: 10px auto;
        }

        .input-with-button input {
            flex-grow: 1;
            margin: 0; /* Override default margin */
            width: auto; /* Override default width */
        }

        #generateUsernameBtn {
            margin-left: 10px;
            padding: 10px;
            background-color: #3498db;
            color: #ecf0f1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        #generateUsernameBtn:hover { background-color: #2980b9; }

.modal .btn-link {
    background: none;
    border: none;
    color: #3498db;
    text-decoration: underline;
    cursor: pointer;
    padding: 10px;
    font-size: 0.9rem;
    margin-top: 10px;
}

.modal .btn-link:hover { color: #5dade2; }

        .modal label {
            display: block;
            text-align: left;
            margin-top: 15px;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #bdc3c7;
        }

        #profileModal p {
            text-align: left;
            font-size: 1.1rem;
            margin: 15px 0;
        }

        #profileModal p strong {
            color: #bdc3c7;
        }

        #profileModalButton {
            background-color: #8e44ad; /* Amethyst */
            color: #ecf0f1;
            border: 2px solid #9b59b6;
            padding: 8px 16px;
            font-size: 1rem;
            font-family: 'Courier New', Courier, monospace;
            cursor: pointer;
            margin: 0 5px;
            
            transition: background-color 0.3s;
            border-radius: 4px;
        }

        #profileModalButton:hover {
            background-color: #9b59b6;
        }

        #settingsModal > .btn-secondary {
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="top-bar">
        <div id="auth-container">
            <button id="loginButton">Sign In</button>
        </div>
        <div id="user-display" class="hidden">
            <img id="profilePic" src="" alt="PFP" class="hidden">
            <span id="welcomeMessage"></span>
            <button id="logoutButton">Logout</button>
        </div>
    </div>

    <h1>SNAKE</h1>
    <div id="score-container">
        <div id="score">Score: 0</div>
        <div id="highScore">High Score: 0</div>
    </div>
    <canvas id="gameCanvas" width="600" height="600"></canvas>
    <p style="margin-top: 1rem;">Use Arrow Keys or WASD to Move</p>
    <div>
        <button id="retryButton" class="hidden">Retry</button>
        <button id="pauseResumeButton">Pause</button>
        <button id="settingsButton">Settings</button>
    </div>

    <div id="settingsModal" class="modal hidden">
        <h2>Settings</h2>
        <div id="profile-setting-container" class="setting-option hidden">
            <h3>Account</h3>
            <button id="profileModalButton">Edit Profile</button>
        </div>
        <div class="setting-option">
            <h3>Game Speed</h3>
            <div id="speed-controls">
                <button class="speed-option" data-speed="180">Slow</button>
                <button class="speed-option" data-speed="120">Normal</button>
                <button class="speed-option" data-speed="70">Fast</button>
            </div>
        </div>
        <div class="setting-option">
            <h3>Graphics Style</h3>
            <div id="graphics-controls">
                <button class="graphics-option" data-style="modern">Modern</button>
                <button class="graphics-option" data-style="classic">Classic</button>
                <button class="graphics-option" data-style="cyber">Cyber</button>
                <button class="graphics-option" data-style="neon">Neon</button>
                <button class="graphics-option" data-style="8bit">8-Bit</button>
                <button class="graphics-option" data-style="ghost">Ghost</button>
                <button class="graphics-option" data-style="rainbow">Rainbow</button>
                <button class="graphics-option" data-style="minimal">Minimal</button>
                <button class="graphics-option" data-style="matrix">Matrix</button>
                <button class="graphics-option" data-style="blueprint">Blueprint</button>
                <button class="graphics-option" data-style="fire">Fire</button>
                <button class="graphics-option" data-style="ice">Ice</button>
                <button class="graphics-option" data-style="jungle">Jungle</button>
            </div>
        </div>
        <div class="setting-option">
            <h3>Background</h3>
            <div id="background-controls">
                <button class="background-option" data-style="black">Black</button>
                <button class="background-option" data-style="blue">Blue</button>
                <button class="background-option" data-style="stars">Stars</button>
                <button class="background-option" data-style="forest">Forest</button>
                <button class="background-option" data-style="ocean">Ocean</button>
                <button class="background-option" data-style="desert">Desert</button>
                <button class="background-option" data-style="sunset">Sunset</button>
                <button class="background-option" data-style="sky">Sky</button>
                <button class="background-option" data-style="stone">Stone</button>
                <button class="background-option" data-style="wine">Wine</button>
                <button class="background-option" data-style="lavender">Lavender</button>
                <button class="background-option" data-style="mint">Mint</button>
                <button class="background-option" data-style="sunrise">Sunrise</button>
            </div>
            <div class="input-with-button" style="margin-top: 10px;">
                <input type="text" id="customBgUrl" placeholder="Image URL for background">
                <button type="button" id="applyCustomBgBtn">Apply</button>
            </div>
        </div>
        <div id="admin-settings-container" class="setting-option hidden">
            <h3>Admin</h3>
            <button id="resetAllAccountsBtn" class="btn-danger">Reset All Accounts</button>
        </div>
        <button id="closeSettings" class="btn-secondary">Close</button>
    </div>

    <!-- Login and Signup Modals -->
    <div id="loginModal" class="modal hidden">
        <h2>Sign in</h2>
        <p style="margin-top: -10px; margin-bottom: 20px; color: #bdc3c7;">to continue to Snake Game</p>
        <form id="loginForm">
            <!-- Step 1: Identifier -->
            <div id="loginStep1">
                <input type="text" id="loginIdentifier" placeholder="Username, Email, Mobile, or Code" required>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <button type="button" id="forgotPasswordBtn" class="btn-link" style="text-align: left; padding: 5px 0;">Forgot Password?</button>
                    <button type="button" id="forgotCodeBtn" class="btn-link" style="text-align: right; padding: 5px 0;">Forgot Code?</button>
                </div>
                <div class="modal-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <button type="button" id="switchToSignupBtn" class="btn-link">Create account</button>
                    <button type="button" id="loginNextBtn" class="btn-primary">Next</button>
                </div>
            </div>

            <!-- Step 2: Password -->
            <div id="loginStep2" class="hidden">
                <div id="login-user-info">
                    <img id="loginPfp" src="" alt="PFP" class="hidden">
                    <span id="loginIdentifierDisplay"></span>
                </div>
                <input type="password" id="loginPassword" placeholder="Enter your password" required>
                <div class="modal-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <button type="button" id="loginBackBtn" class="btn-secondary">Back</button>
                    <button type="button" id="loginNextBtn2" class="btn-primary">Next</button>
                </div>
            </div>

            <!-- Step 3: Code -->
            <div id="loginStep3" class="hidden">
                <p>For your security, please enter your 6-digit code.</p>
                <input type="text" id="loginUserCode" placeholder="6-Digit Login Code" required pattern="\d{6}" maxlength="6">
                <div class="modal-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <button type="button" id="loginBackBtn2" class="btn-secondary">Back</button>
                    <button type="submit" class="btn-primary">Login</button>
                </div>
            </div>
        </form>
    </div>

    <div id="signupModal" class="modal hidden">
        <h2>Create account</h2>
        <p style="margin-top: -10px; margin-bottom: 20px; color: #bdc3c7;">to play Snake Game</p>
        <form id="signupForm">
            <!-- Step 1: Basic Info -->
            <div id="signupStep1">
                <div class="input-with-button">
                    <input type="text" id="signupUsername" placeholder="Username" required>
                    <button type="button" id="generateUsernameBtn">Generate</button>
                </div>
                <input type="email" id="signupEmail" placeholder="Email (optional)">
                <div class="modal-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <button type="button" id="switchToLoginBtn" class="btn-link">Sign in instead</button>
                    <button type="button" id="signupNextBtn" class="btn-primary">Next</button>
                </div>
            </div>

            <!-- Step 2: Contact Info -->
            <div id="signupStep2" class="hidden">
                <input type="tel" id="signupMobile" placeholder="Mobile Number" required>
                <div class="modal-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <button type="button" id="signupBackBtn" class="btn-secondary">Back</button>
                    <button type="button" id="signupNextBtn2" class="btn-primary">Next</button>
                </div>
            </div>

            <!-- Step 3: Password -->
            <div id="signupStep3" class="hidden">
                <input type="password" id="signupPassword" placeholder="Create a password" required>
                <div class="modal-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <button type="button" id="signupBackBtn2" class="btn-secondary">Back</button>
                    <button type="button" id="signupNextBtn3" class="btn-primary">Next</button>
                </div>
            </div>

            <!-- Step 4: Security Code -->
            <div id="signupStep4" class="hidden">
                <input type="text" id="signupUserCode" placeholder="6-Digit Login Code" required pattern="\d{6}" maxlength="6" title="Must be 6 digits">
                <div class="modal-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                    <button type="button" id="signupBackBtn3" class="btn-secondary">Back</button>
                    <button type="submit" class="btn-primary">Create account</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal hidden">
        <h2>Edit Profile</h2>
        <form id="profileEditForm">
            <label for="profileUsernameInput">Username</label>
            <input type="text" id="profileUsernameInput" required>
            <small style="display: block; text-align: left; margin: -5px 0 10px; color: #f1c40f;">Warning: Changing username logs you out.</small>

            <label for="profileEmailInput">Email</label>
            <input type="email" id="profileEmailInput">

            <label for="profileMobileInput">Mobile</label>
            <input type="tel" id="profileMobileInput" required>

            <label for="profileUserCodeInput">6-Digit Login Code</label>
            <input type="text" id="profileUserCodeInput" required pattern="\d{6}" maxlength="6">

            <label for="profilePicUrl">Profile Picture URL</label>
            <input type="text" id="profilePicUrl" placeholder="https://example.com/image.png">

            <div class="modal-actions" style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                <button type="button" id="deleteAccountButton" class="btn-danger">Delete Account</button>
                <div>
                    <button type="button" class="close-modal btn-secondary" style="margin-right: 10px;">Cancel</button>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </div>
        </form>
    </div>

    <!-- Account Selection Modal -->
    <div id="accountSelectionModal" class="modal hidden">
        <h2>Select Account</h2>
        <p>This mobile number is linked to multiple accounts. Please select one to continue.</p>
        <div id="accountList"></div>
        <button type="button" class="close-modal btn-secondary" style="margin-top: 20px;">Cancel</button>
    </div>

    <!-- Forgot/Reset Password Modals -->
    <div id="forgotPasswordModal" class="modal hidden">
        <h2>Forgot Password</h2>
        <p>Enter your email, mobile, or login code to find your account.</p>
        <form id="forgotPasswordForm">
            <input type="text" id="forgotIdentifier" placeholder="Email, Mobile, or Code" required>
            <div class="modal-actions">
                <button type="submit" class="btn-primary">Find Account</button>
                <button type="button" class="close-modal btn-secondary">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Forgot Code Modal -->
    <div id="forgotCodeModal" class="modal hidden">
        <h2>Get Your Login Code</h2>
        <form id="forgotCodeForm">
            <!-- Step 1: Find Account -->
            <div id="forgotCodeStep1">
                <p>Enter your email or mobile number to find your account.</p>
                <input type="text" id="forgotCodeIdentifier" placeholder="Email or Mobile" required>
                <div class="modal-actions">
                    <button type="submit" class="btn-primary">Find Account</button>
                    <button type="button" class="close-modal btn-secondary">Cancel</button>
                </div>
            </div>

            <!-- Step 2: Verify and Show Code -->
            <div id="forgotCodeStep2" class="hidden">
                <p>To show the code for <strong id="forgotCodeUsername"></strong>, please enter your password.</p>
                <input type="password" id="forgotCodePassword" placeholder="Password" required>
                <div class="modal-actions">
                    <button type="button" id="verifyAndShowCodeBtn" class="btn-primary">Show Code</button>
                    <button type="button" class="close-modal btn-secondary">Cancel</button>
                </div>
                <div id="showCodeResult" class="hidden" style="margin-top: 20px; font-size: 1.5rem;">
                    Your login code is: <strong id="userCodeResult" style="color: #2ecc71;"></strong>
                </div>
            </div>
        </form>
    </div>

    <div id="resetPasswordModal" class="modal hidden">
        <h2>Reset Password</h2>
        <p>Enter a new password for account: <strong id="resetUsername"></strong></p>
        <form id="resetPasswordForm">
            <input type="password" id="newPassword" placeholder="New Password" required>
            <input type="password" id="confirmNewPassword" placeholder="Confirm New Password" required>
            <div class="modal-actions">
                <button type="submit" class="btn-primary">Reset Password</button>
                <button type="button" class="close-modal btn-secondary">Cancel</button>
            </div>
        </form>
    </div>

    <script>
        // --- SETUP ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score');
        const retryButton = document.getElementById('retryButton');
        const pauseResumeButton = document.getElementById('pauseResumeButton');
        const highScoreDisplay = document.getElementById('highScore');
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsButton = document.getElementById('closeSettings');
        const speedControlButtons = document.querySelectorAll('.speed-option');
        const graphicsControlButtons = document.querySelectorAll('.graphics-option');
        const backgroundControlButtons = document.querySelectorAll('.background-option');
        // Auth elements
        const authContainer = document.getElementById('auth-container');
        const userDisplay = document.getElementById('user-display');
        const loginButton = document.getElementById('loginButton');
        const profilePic = document.getElementById('profilePic');
        const logoutButton = document.getElementById('logoutButton');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const loginModal = document.getElementById('loginModal');
        const signupModal = document.getElementById('signupModal');
        const profileModal = document.getElementById('profileModal');
        const accountSelectionModal = document.getElementById('accountSelectionModal');
        const accountList = document.getElementById('accountList');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const loginIdentifierInput = document.getElementById('loginIdentifier');
        const loginPasswordInput = document.getElementById('loginPassword');
        const signupUsernameInput = document.getElementById('signupUsername');
        const signupEmailInput = document.getElementById('signupEmail');
        const signupMobileInput = document.getElementById('signupMobile');
        const signupPasswordInput = document.getElementById('signupPassword');
        const profileEditForm = document.getElementById('profileEditForm');
        const profileUsernameInput = document.getElementById('profileUsernameInput');
        const profileEmailInput = document.getElementById('profileEmailInput');
        const profileMobileInput = document.getElementById('profileMobileInput');
        const profileUserCodeInput = document.getElementById('profileUserCodeInput');
        const closeModalButtons = document.querySelectorAll('.close-modal');
        const profileSettingContainer = document.getElementById('profile-setting-container');
        const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
        const forgotPasswordModal = document.getElementById('forgotPasswordModal');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        const resetPasswordModal = document.getElementById('resetPasswordModal');
        const resetPasswordForm = document.getElementById('resetPasswordForm');
        const forgotCodeBtn = document.getElementById('forgotCodeBtn');
        const forgotCodeModal = document.getElementById('forgotCodeModal');
        const forgotCodeForm = document.getElementById('forgotCodeForm');
        const forgotCodeStep1 = document.getElementById('forgotCodeStep1');
        const forgotCodeStep2 = document.getElementById('forgotCodeStep2');
        const forgotCodeIdentifierInput = document.getElementById('forgotCodeIdentifier');
        const forgotCodeUsernameDisplay = document.getElementById('forgotCodeUsername');
        const forgotCodePasswordInput = document.getElementById('forgotCodePassword');
        const verifyAndShowCodeBtn = document.getElementById('verifyAndShowCodeBtn');
        const showCodeResult = document.getElementById('showCodeResult');
        const userCodeResult = document.getElementById('userCodeResult');
        const resetUsernameDisplay = document.getElementById('resetUsername');
        const profileModalButton = document.getElementById('profileModalButton');
        const deleteAccountButton = document.getElementById('deleteAccountButton');
        const profilePicUrlInput = document.getElementById('profilePicUrl');
        const customBgUrlInput = document.getElementById('customBgUrl');
        const applyCustomBgBtn = document.getElementById('applyCustomBgBtn');
        const adminSettingsContainer = document.getElementById('admin-settings-container');
        const resetAllAccountsBtn = document.getElementById('resetAllAccountsBtn');
        const loginNextBtn = document.getElementById('loginNextBtn');
        const loginBackBtn = document.getElementById('loginBackBtn');
        const loginStep1 = document.getElementById('loginStep1');
        const loginStep2 = document.getElementById('loginStep2');
        const loginStep3 = document.getElementById('loginStep3');
        const loginNextBtn2 = document.getElementById('loginNextBtn2');
        const loginBackBtn2 = document.getElementById('loginBackBtn2');
        const loginUserCodeInput = document.getElementById('loginUserCode');
        const loginIdentifierDisplay = document.getElementById('loginIdentifierDisplay');
        const loginPfp = document.getElementById('loginPfp');
        const switchToLoginBtn = document.getElementById('switchToLoginBtn');
        const switchToSignupBtn = document.getElementById('switchToSignupBtn');
        const signupStep1 = document.getElementById('signupStep1');
        const signupStep2 = document.getElementById('signupStep2');
        const signupNextBtn = document.getElementById('signupNextBtn');
        const signupBackBtn = document.getElementById('signupBackBtn');
        const signupStep3 = document.getElementById('signupStep3');
        const signupNextBtn2 = document.getElementById('signupNextBtn2');
        const signupBackBtn2 = document.getElementById('signupBackBtn2');
        const signupStep4 = document.getElementById('signupStep4');
        const signupNextBtn3 = document.getElementById('signupNextBtn3');
        const signupBackBtn3 = document.getElementById('signupBackBtn3');

        const generateUsernameBtn = document.getElementById('generateUsernameBtn');
        // Game constants
        const GRID_SIZE = 20;
        const TILE_COUNT = canvas.width / GRID_SIZE; // 600 / 20 = 30

        // Game state
        let backgroundStyle = 'black';
        const STAR_COUNT = 150; // Number of stars for the starfield background
        let stars = [];
        let graphicsStyle = 'modern'; // Default style
        let gameSpeed = 120; // Default speed, will be updated from settings
        let snake = [{ x: 15, y: 15 }]; // Snake starts in the middle of 600x600 grid
        let food = { x: 20, y: 20 };
        let dx = 0; // Direction x
        let dy = 0; // Direction y
        let score = 0;
        let highScore = 0;
        let gameOver = false;
        let isPaused = false;
        let changingDirection = false; // Prevents rapid 180-degree turns
        let userToResetPassword = null;
        let userToGetCode = null; // Will store { username, userData } for the forgot code flow
        let loginFlowUser = null; // Will store { username, userData } for the multi-step login

        // --- GAME LOGIC ---

        /**
         * The main function that runs the game loop.
         */
        function main() {
            if (gameOver) {
                displayGameOver();
                return;
            }

            if (isPaused) {
                displayPaused();
                return;
            }

            changingDirection = false;
            setTimeout(function onTick() {
                clearCanvas();
                drawFood();
                moveSnake();
                drawSnake();
                // Call main again to create the loop
                main();
            }, gameSpeed);
        }

        /**
         * Clears the canvas for the next frame.
         */
        function clearCanvas() {
            // Specific graphics styles can define their own background
            if (graphicsStyle === 'blueprint') {
                ctx.fillStyle = '#00008B'; // DarkBlue for blueprint paper
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            // When using a body background, we just clear the canvas
            else if (backgroundStyle === 'custom') {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            } else if (backgroundStyle === 'blue') {
                ctx.fillStyle = '#1a1a2e'; // A dark navy blue
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (backgroundStyle === 'forest') {
                ctx.fillStyle = '#004d00'; // Dark green
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (backgroundStyle === 'ocean') {
                ctx.fillStyle = '#008080'; // Teal
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (backgroundStyle === 'desert') {
                ctx.fillStyle = '#c2b280'; // Sandy brown
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (backgroundStyle === 'sky') {
                ctx.fillStyle = '#87CEEB'; // Light blue
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (backgroundStyle === 'stone') {
                ctx.fillStyle = '#696969'; // Dark grey
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (backgroundStyle === 'wine') {
                ctx.fillStyle = '#722f37'; // Dark red
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (backgroundStyle === 'lavender') {
                ctx.fillStyle = '#E6E6FA'; // Light purple
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (backgroundStyle === 'mint') {
                ctx.fillStyle = '#98FF98'; // Light green
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (backgroundStyle === 'sunset') {
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#ff8c00'); // Dark Orange
                gradient.addColorStop(0.5, '#ff4500'); // Orange Red
                gradient.addColorStop(1, '#4b0082'); // Indigo
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else if (backgroundStyle === 'sunrise') {
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#87CEEB'); // Sky Blue
                gradient.addColorStop(1, '#FFD700'); // Gold
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else { // black or stars background is black
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            // Draw stars if applicable (and not on blueprint)
            if (backgroundStyle === 'stars' && graphicsStyle !== 'blueprint') {
                ctx.fillStyle = 'white';
                stars.forEach(star => {
                    // Make stars twinkle
                    star.radius = Math.random() * 1.5;
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.radius, 0, 2 * Math.PI);
                    ctx.fill();
                });
            }

            // Then draw the grid on top
            drawGrid();
        }

        /**
         * Draws a subtle grid on the canvas.
         */
        function drawGrid() {
            let gridColor = '#34495e';
            let gridWidth = 0.5;
            let shadowBlur = 0;
            let shadowColor = 'transparent';

            switch (graphicsStyle) {
                case 'cyber':
                    gridColor = '#4b0082';
                    gridWidth = 0.7;
                    break;
                case 'neon':
                    gridColor = '#ff00ff';
                    gridWidth = 0.5;
                    shadowBlur = 5;
                    shadowColor = '#ff00ff';
                    break;
                case 'minimal':
                    gridColor = '#444';
                    gridWidth = 0.2;
                    break;
                case '8bit':
                    gridColor = '#555';
                    gridWidth = 1;
                    break;
                case 'matrix':
                    gridColor = '#00ff00';
                    gridWidth = 0.3;
                    shadowBlur = 5;
                    shadowColor = '#00ff00';
                    break;
                case 'blueprint':
                    gridColor = '#FFFFFF';
                    gridWidth = 0.4;
                    break;
                case 'fire':
                    gridColor = '#8B0000'; // Dark Red
                    gridWidth = 0.5;
                    break;
                case 'ice':
                    gridColor = '#add8e6'; // Light Blue
                    gridWidth = 0.3;
                    shadowBlur = 5;
                    shadowColor = '#add8e6';
                    break;
                case 'jungle':
                    gridColor = '#006400'; // Dark Green
                    gridWidth = 0.6;
                    break;
            }

            ctx.strokeStyle = gridColor;
            ctx.lineWidth = gridWidth;
            ctx.shadowBlur = shadowBlur;
            ctx.shadowColor = shadowColor;

            for (let x = 0; x <= canvas.width; x += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y <= canvas.height; y += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            // Reset shadow for other drawing operations
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
        }

        /**
         * Draws the snake on the canvas.
         */
        function drawSnake() {
            // Reset effects from other drawing functions (like grid)
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
            ctx.globalAlpha = 1.0;

            if (graphicsStyle === 'classic') {
                ctx.fillStyle = '#2ecc71'; // Classic green
                snake.forEach(part => {
                    ctx.fillRect(part.x * GRID_SIZE, part.y * GRID_SIZE, GRID_SIZE - 1, GRID_SIZE - 1);
                });
            } else if (graphicsStyle === '8bit') {
                snake.forEach((part, index) => {
                    ctx.fillStyle = (index === 0) ? '#00E436' : '#00A8F3'; // Green head, blue body
                    ctx.fillRect(part.x * GRID_SIZE, part.y * GRID_SIZE, GRID_SIZE, GRID_SIZE);
                });
            } else if (graphicsStyle === 'minimal') {
                ctx.strokeStyle = '#ecf0f1';
                ctx.lineWidth = 2;
                snake.forEach((part, index) => {
                    const partX = part.x * GRID_SIZE;
                    const partY = part.y * GRID_SIZE;
                    if (index === 0) {
                        ctx.fillStyle = '#ecf0f1';
                        ctx.fillRect(partX, partY, GRID_SIZE, GRID_SIZE);
                    } else {
                        ctx.strokeRect(partX + 1, partY + 1, GRID_SIZE - 2, GRID_SIZE - 2);
                    }
                });
            } else if (graphicsStyle === 'rainbow') {
                const colors = ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#8f00ff'];
                const cornerRadius = 5;
                const inset = 2;
                snake.forEach((part, index) => {
                    ctx.fillStyle = colors[index % colors.length];
                    ctx.beginPath();
                    ctx.roundRect(part.x * GRID_SIZE + inset, part.y * GRID_SIZE + inset, GRID_SIZE - inset * 2, GRID_SIZE - inset * 2, cornerRadius);
                    ctx.fill();
                });
            } else if (graphicsStyle === 'matrix') {
                ctx.fillStyle = '#00ff00';
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#00ff00';
                ctx.font = `${GRID_SIZE * 0.9}px "Courier New"`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const chars = '01';
                snake.forEach(part => {
                    const char = chars[Math.floor(Math.random() * chars.length)];
                    ctx.fillText(char, part.x * GRID_SIZE + GRID_SIZE / 2, part.y * GRID_SIZE + GRID_SIZE / 2);
                });
            } else if (graphicsStyle === 'blueprint') {
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = 2;
                snake.forEach((part, index) => {
                    const partX = part.x * GRID_SIZE;
                    const partY = part.y * GRID_SIZE;
                    if (index === 0) {
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(partX + 1, partY + 1, GRID_SIZE - 2, GRID_SIZE - 2);
                    } else {
                        ctx.strokeRect(partX + 1, partY + 1, GRID_SIZE - 2, GRID_SIZE - 2);
                    }
                });
            } else if (graphicsStyle === 'fire') {
                const colors = ['#ff4500', '#ff6347', '#ff7f50']; // OrangeRed, Tomato, Coral
                const cornerRadius = 6;
                ctx.shadowBlur = 10;
                snake.forEach((part, index) => {
                    const color = colors[index % colors.length];
                    ctx.fillStyle = color;
                    ctx.shadowColor = color;
                    ctx.beginPath();
                    ctx.roundRect(part.x * GRID_SIZE + 1, part.y * GRID_SIZE + 1, GRID_SIZE - 2, GRID_SIZE - 2, cornerRadius);
                    ctx.fill();
                });
            } else if (graphicsStyle === 'ice') {
                const colors = ['#afeeee', '#b0e0e6', '#add8e6']; // PaleTurquoise, PowderBlue, LightBlue
                const cornerRadius = 2; // Sharper edges
                ctx.globalAlpha = 0.85;
                snake.forEach((part, index) => {
                    ctx.fillStyle = colors[index % colors.length];
                    ctx.strokeStyle = '#FFFFFF';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.roundRect(part.x * GRID_SIZE + 2, part.y * GRID_SIZE + 2, GRID_SIZE - 4, GRID_SIZE - 4, cornerRadius);
                    ctx.fill();
                    ctx.stroke();
                });
            } else if (graphicsStyle === 'jungle') {
                const colors = ['#228B22', '#556B2F', '#6B8E23']; // ForestGreen, DarkOliveGreen, OliveDrab
                const cornerRadius = 4;
                snake.forEach((part, index) => {
                    ctx.fillStyle = colors[index % colors.length];
                    ctx.beginPath();
                    ctx.roundRect(part.x * GRID_SIZE + 2, part.y * GRID_SIZE + 2, GRID_SIZE - 4, GRID_SIZE - 4, cornerRadius);
                    ctx.fill();
                });
            } else { // Covers modern, cyber, neon, ghost (all rounded)
                const cornerRadius = (graphicsStyle === 'cyber') ? 3 : 5;
                const inset = 2;
                let headColor = (graphicsStyle === 'cyber') ? '#00e5ff' : '#27ae60';
                let bodyColor = (graphicsStyle === 'cyber') ? '#00b8d4' : '#2ecc71';
                let eyeColor = (graphicsStyle === 'cyber') ? '#ffeb3b' : 'white';

                if (graphicsStyle === 'neon') {
                    headColor = '#00e5ff';
                    bodyColor = '#00e5ff';
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = headColor;
                }
                if (graphicsStyle === 'ghost') {
                    ctx.globalAlpha = 0.6;
                }

                snake.forEach((part, index) => {
                    const partX = part.x * GRID_SIZE;
                    const partY = part.y * GRID_SIZE;

                    if (index === 0) { // Head
                        ctx.fillStyle = headColor;
                        ctx.beginPath();
                        ctx.roundRect(partX + inset, partY + inset, GRID_SIZE - inset * 2, GRID_SIZE - inset * 2, cornerRadius);
                        ctx.fill();

                        // --- Draw Eyes ---
                        ctx.fillStyle = eyeColor;
                        // For ghost, make eyes more visible
                        if (graphicsStyle === 'ghost') {
                            ctx.globalAlpha = 1.0;
                        }

                        // Define eye properties
                        const eyeSize = GRID_SIZE / 6;
                        let eye1X, eye1Y, eye2X, eye2Y;
                        const headCenterX = partX + GRID_SIZE / 2;
                        const headCenterY = partY + GRID_SIZE / 2;
                        const eyeOffset = GRID_SIZE / 4;

                        // Determine eye positions based on direction
                        if (dx === 1) { // Moving Right
                            eye1X = headCenterX + eyeOffset / 2;
                            eye1Y = headCenterY - eyeOffset;
                            eye2X = headCenterX + eyeOffset / 2;
                            eye2Y = headCenterY + eyeOffset;
                        } else if (dx === -1) { // Moving Left
                            eye1X = headCenterX - eyeOffset / 2;
                            eye1Y = headCenterY - eyeOffset;
                            eye2X = headCenterX - eyeOffset / 2;
                            eye2Y = headCenterY + eyeOffset;
                        } else if (dy === 1) { // Moving Down
                            eye1X = headCenterX - eyeOffset;
                            eye1Y = headCenterY + eyeOffset / 2;
                            eye2X = headCenterX + eyeOffset;
                            eye2Y = headCenterY + eyeOffset / 2;
                        } else { // Moving Up (dy === -1) or initial state (dx=0, dy=0)
                            eye1X = headCenterX - eyeOffset;
                            eye1Y = headCenterY - eyeOffset / 2;
                            eye2X = headCenterX + eyeOffset;
                            eye2Y = headCenterY - eyeOffset / 2;
                        }

                        ctx.beginPath();
                        ctx.arc(eye1X, eye1Y, eyeSize, 0, 2 * Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(eye2X, eye2Y, eyeSize, 0, 2 * Math.PI);
                        ctx.fill();
                    } else { // Body
                        ctx.fillStyle = bodyColor;
                        ctx.beginPath();
                        ctx.roundRect(partX + inset, partY + inset, GRID_SIZE - inset * 2, GRID_SIZE - inset * 2, cornerRadius);
                        ctx.fill();
                    }
                });

                // Reset any global effects
                ctx.shadowBlur = 0;
                ctx.shadowColor = 'transparent';
                ctx.globalAlpha = 1.0;
            }
        }

        /**
         * Draws the food on the canvas.
         */
        function drawFood() {
            // Reset effects
            ctx.shadowBlur = 0;
            ctx.shadowColor = 'transparent';
            ctx.globalAlpha = 1.0;

            const foodX = food.x * GRID_SIZE;
            const foodY = food.y * GRID_SIZE;

            if (graphicsStyle === 'classic') {
                ctx.fillStyle = '#e74c3c'; // Classic red
                ctx.fillRect(foodX, foodY, GRID_SIZE, GRID_SIZE);
            } else if (graphicsStyle === '8bit') {
                ctx.fillStyle = '#FF4500'; // OrangeRed
                ctx.fillRect(foodX, foodY, GRID_SIZE, GRID_SIZE);
            } else if (graphicsStyle === 'minimal') {
                ctx.strokeStyle = '#e74c3c';
                ctx.lineWidth = 2;
                ctx.strokeRect(foodX + 1, foodY + 1, GRID_SIZE - 2, GRID_SIZE - 2);
            } else if (graphicsStyle === 'rainbow') {
                // A white, glowing food to contrast the snake
                const radius = GRID_SIZE / 2;
                const centerX = foodX + radius;
                const centerY = foodY + radius;
                ctx.fillStyle = 'white';
                ctx.shadowBlur = 10;
                ctx.shadowColor = 'white';
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius - 3, 0, 2 * Math.PI);
                ctx.fill();
                ctx.shadowBlur = 0; // Reset
            } else if (graphicsStyle === 'matrix') {
                ctx.fillStyle = '#90ee90'; // LightGreen, to stand out from snake
                ctx.shadowBlur = 15;
                ctx.shadowColor = '#90ee90';
                ctx.fillRect(foodX, foodY, GRID_SIZE, GRID_SIZE);
            } else if (graphicsStyle === 'blueprint') {
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = 2;
                ctx.strokeRect(foodX + 2, foodY + 2, GRID_SIZE - 4, GRID_SIZE - 4);
            } else if (graphicsStyle === 'fire') {
                ctx.fillStyle = '#36454F'; // Charcoal, like fuel
                ctx.shadowBlur = 5;
                ctx.shadowColor = '#ff4500';
                ctx.beginPath();
                ctx.arc(foodX + GRID_SIZE / 2, foodY + GRID_SIZE / 2, GRID_SIZE / 2 - 2, 0, 2 * Math.PI);
                ctx.fill();
            } else if (graphicsStyle === 'ice') {
                ctx.fillStyle = 'white';
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#afeeee';
                ctx.beginPath();
                ctx.arc(foodX + GRID_SIZE / 2, foodY + GRID_SIZE / 2, GRID_SIZE / 2 - 3, 0, 2 * Math.PI);
                ctx.fill();
            } else if (graphicsStyle === 'jungle') {
                ctx.fillStyle = '#FFD700'; // Gold, like a banana or tropical fruit
                ctx.beginPath();
                ctx.arc(foodX + GRID_SIZE / 2, foodY + GRID_SIZE / 2, GRID_SIZE / 2 - 2, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            else { // modern, cyber, neon, ghost
                const radius = GRID_SIZE / 2;
                const centerX = foodX + radius;
                const centerY = foodY + radius;

                let gradColor1 = (graphicsStyle === 'cyber') ? '#f06292' : '#ff7675'; // Pink vs Red
                let gradColor2 = (graphicsStyle === 'cyber') ? '#c2185b' : '#d63031'; // Darker Pink vs Darker Red

                if (graphicsStyle === 'neon') {
                    gradColor1 = '#ffeb3b'; // Yellow
                    gradColor2 = '#fdd835'; // Darker Yellow
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = gradColor1;
                }
                if (graphicsStyle === 'ghost') {
                    ctx.globalAlpha = 0.7;
                }

                const grad = ctx.createRadialGradient(centerX - radius * 0.2, centerY - radius * 0.2, radius * 0.1, centerX, centerY, radius - 2);
                grad.addColorStop(0, gradColor1);
                grad.addColorStop(1, gradColor2);

                ctx.fillStyle = grad;
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius - 2, 0, 2 * Math.PI);
                ctx.fill();

                // Highlight
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.beginPath();
                ctx.arc(centerX - radius * 0.3, centerY - radius * 0.4, radius / 4, 0, 2 * Math.PI);
                ctx.fill();

                // Reset effects
                ctx.shadowBlur = 0;
                ctx.globalAlpha = 1.0;
            }
        }

        /**
         * Updates the snake's position and checks for collisions or food.
         */
        function moveSnake() {
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };
            snake.unshift(head); // Add new head to the front

            if (checkCollision()) {
                gameOver = true;
                return;
            }

            const hasEatenFood = snake[0].x === food.x && snake[0].y === food.y;
            if (hasEatenFood) {
                score += 10;
                scoreDisplay.textContent = `Score: ${score}`;
                generateFood();
            } else {
                snake.pop(); // Remove tail segment
            }
        }

        /**
         * Checks for wall or self-collision.
         * @returns {boolean} True if a collision occurred.
         */
        function checkCollision() {
            // Self-collision
            for (let i = 4; i < snake.length; i++) {
                if (snake[i].x === snake[0].x && snake[i].y === snake[0].y) return true;
            }
            // Wall collision
            const hitLeftWall = snake[0].x < 0;
            const hitRightWall = snake[0].x >= TILE_COUNT;
            const hitTopWall = snake[0].y < 0;
            const hitBottomWall = snake[0].y >= TILE_COUNT;
            return hitLeftWall || hitRightWall || hitTopWall || hitBottomWall;
        }

        /**
         * Generates a new food item at a random location not on the snake.
         */
        function generateFood() {
            food.x = Math.floor(Math.random() * TILE_COUNT);
            food.y = Math.floor(Math.random() * TILE_COUNT);
            // If food is on the snake, generate a new one
            snake.forEach(part => {
                if (part.x === food.x && part.y === food.y) generateFood();
            });
        }

        /**
         * Handles keyboard input to change the snake's direction.
         */
        function changeDirection(event) {
            const keyPressed = event.key.toLowerCase();

            // Toggle pause with 'p' key, but not if game is over
            if (keyPressed === 'p' && !gameOver) {
                togglePause();
                return;
            }

            // Handle restart on 'Enter' key if game is over
            if (gameOver) {
                if (keyPressed === 'enter') {
                    restartGame();
                }
                return;
            }

            if (isPaused || changingDirection) return;
            changingDirection = true;

            const goingUp = dy === -1;
            const goingDown = dy === 1;
            const goingRight = dx === 1;
            const goingLeft = dx === -1;

            if ((keyPressed === "arrowleft" || keyPressed === "a") && !goingRight) { dx = -1; dy = 0; }
            if ((keyPressed === "arrowup" || keyPressed === "w") && !goingDown) { dx = 0; dy = -1; }
            if ((keyPressed === "arrowright" || keyPressed === "d") && !goingLeft) { dx = 1; dy = 0; }
            if ((keyPressed === "arrowdown" || keyPressed === "s") && !goingUp) { dx = 0; dy = 1; }
        }

        function displayGameOver() {
            // Semi-transparent overlay
            retryButton.classList.remove('hidden');
            pauseResumeButton.classList.add('hidden');

            let isNewHighScore = false;
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('snakeGameHighScore', highScore);
                highScoreDisplay.textContent = `High Score: ${highScore}`;
                isNewHighScore = true;
            }

            ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (isNewHighScore) {
                ctx.fillStyle = '#f1c40f'; // Gold color for the reward message
                ctx.font = '24px "Courier New"';
                ctx.fillText('New High Score!', canvas.width / 2, canvas.height / 2 - 80);
            }

            ctx.fillStyle = '#ecf0f1';
            ctx.font = '40px "Courier New"';
            ctx.textAlign = 'center';
            ctx.fillText('Game Over', canvas.width / 2, canvas.height / 2 - 40);

            ctx.font = '20px "Courier New"';
            ctx.fillText(`Final Score: ${score}`, canvas.width / 2, canvas.height / 2 + 10);

            ctx.font = '16px "Courier New"';
            ctx.fillText('Press ENTER to Play Again', canvas.width / 2, canvas.height / 2 + 50);
        }

        function displayPaused() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.75)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#f1c40f';
            ctx.font = '40px "Courier New"';
            ctx.textAlign = 'center';
            ctx.fillText('Paused', canvas.width / 2, canvas.height / 2);

            ctx.font = '16px "Courier New"';
            ctx.fillText("Press 'P' or Resume to Continue", canvas.width / 2, canvas.height / 2 + 40);
        }

        function togglePause() {
            if (gameOver) return; // Don't allow pause if game is over

            isPaused = !isPaused;
            if (isPaused) {
                pauseResumeButton.textContent = 'Resume';
                displayPaused(); // Draw paused screen immediately
            } else {
                pauseResumeButton.textContent = 'Pause';
                main(); // Resume the game loop
            }
        }

        function restartGame() {
            snake = [{ x: 15, y: 15 }];
            dx = 0;
            dy = 0;
            score = 0;
            gameOver = false;
            isPaused = false;
            retryButton.classList.add('hidden');
            pauseResumeButton.classList.remove('hidden');
            pauseResumeButton.textContent = 'Pause';
            scoreDisplay.textContent = `Score: ${score}`;
            main();
        }

        // --- SETTINGS LOGIC ---
        function applySpeed(newSpeed) {
            gameSpeed = parseInt(newSpeed, 10);
            localStorage.setItem('snakeGameSpeed', gameSpeed);

            // Update button styles
            speedControlButtons.forEach(btn => {
                if (parseInt(btn.dataset.speed, 10) === gameSpeed) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function applyGraphicsStyle(newStyle) {
            graphicsStyle = newStyle;
            localStorage.setItem('snakeGameGraphics', graphicsStyle);

            graphicsControlButtons.forEach(btn => {
                if (btn.dataset.style === graphicsStyle) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function applyCustomBackground(url) {
            if (!url) {
                document.body.style.backgroundImage = '';
                localStorage.removeItem('snakeGameCustomBg');
                if (backgroundStyle === 'custom') {
                    applyBackgroundStyle('black'); // Revert to default
                }
                return;
            }
            const img = new Image();
            img.crossOrigin = "Anonymous"; // Handle potential CORS issues
            img.onload = () => {
                document.body.style.backgroundImage = `url(${url})`;
                localStorage.setItem('snakeGameCustomBg', url);
                applyBackgroundStyle('custom'); // Activate the custom style
            };
            img.onerror = () => {
                alert('Could not load image. Please check the URL and try again.');
            };
            img.src = url;
        }

        function generateStars() {
            if (stars.length > 0) return; // Only generate once
            for (let i = 0; i < STAR_COUNT; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    radius: Math.random() * 1.5
                });
            }
        }

        function applyBackgroundStyle(newStyle) {
            backgroundStyle = newStyle;
            localStorage.setItem('snakeGameBackground', backgroundStyle);

            if (backgroundStyle === 'stars') {
                generateStars();
            }

            // If a preset is chosen, clear the custom URL input
            if (newStyle !== 'custom') {
                document.body.style.backgroundImage = '';
                customBgUrlInput.value = '';
                localStorage.removeItem('snakeGameCustomBg');
            }

            backgroundControlButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.style === backgroundStyle);
            });
        }

        function showProfileModal() {
            const loggedInUser = localStorage.getItem('snakeLoggedInUser');
            if (!loggedInUser) return;
    
            const userDataString = localStorage.getItem(`snakeUser-${loggedInUser}`);
            if (userDataString) {
                try {
                    const userData = JSON.parse(userDataString);
                    // Store original username to detect changes
                    profileEditForm.dataset.originalUsername = loggedInUser;
    
                    // Populate the form fields
                    profileUsernameInput.value = loggedInUser;
                    profileEmailInput.value = userData.email || '';
                    profileMobileInput.value = userData.mobile || '';
                    profileUserCodeInput.value = userData.userCode || '';
                    profilePicUrlInput.value = userData.pfp || '';
    
                    profileModal.classList.remove('hidden');
                } catch (error) {
                    console.error('Could not load profile data.', error);
                    alert('Could not load profile data.');
                }
            }
        }

        function showAccountSelectionModal(accounts) {
            accountList.innerHTML = ''; // Clear previous list
            accounts.forEach(accUsername => {
                const button = document.createElement('button');
                button.textContent = accUsername;
                button.classList.add('btn-primary');
                button.addEventListener('click', () => {
                    // Log in with the selected username
                    localStorage.setItem('snakeLoggedInUser', accUsername);
                    showLoggedInState(accUsername);
                    // Hide all modals
                    loginModal.classList.add('hidden');
                    accountSelectionModal.classList.add('hidden');
                });
                accountList.appendChild(button);
            });
            loginModal.classList.add('hidden');
            accountSelectionModal.classList.remove('hidden');
        }

        function handleDeleteAccount() {
            const loggedInUser = localStorage.getItem('snakeLoggedInUser');
            if (!loggedInUser) {
                alert('No user is logged in.');
                return;
            }

            const confirmation = window.confirm(
                `Are you sure you want to permanently delete the account "${loggedInUser}"? This action cannot be undone.`
            );

            if (confirmation) {
                // Remove user data from storage
                localStorage.removeItem(`snakeUser-${loggedInUser}`);
                
                // Log the user out (which also removes the session and updates UI)
                handleLogout();
                alert(`Account "${loggedInUser}" has been deleted.`);
            }
        }

        function handleResetAllAccounts() {
            const confirmation = window.confirm(
                "DANGER: This will permanently delete ALL user accounts and their data from this browser's storage. This action cannot be undone. Are you absolutely sure?"
            );

            if (confirmation) {
                // Find all account keys and remove them
                const keysToRemove = [];
                for (const key of Object.keys(localStorage)) {
                    if (key.startsWith('snakeUser-')) {
                        keysToRemove.push(key);
                    }
                }

                keysToRemove.forEach(key => localStorage.removeItem(key));

                // Also remove the logged-in session key
                localStorage.removeItem('snakeLoggedInUser');

                // Update the UI to reflect the logged-out state.
                // handleLogout() will hide the profile modal and update the top bar.
                handleLogout();

                alert('All user accounts have been successfully deleted.');
            }
        }

        /**
         * Checks if a given identifier (email, mobile, code) is already taken by another user.
         * @param {string} type - The type of identifier ('email', 'mobile', 'userCode').
         * @param {string} value - The value to check.
         * @param {string} currentUsername - The username of the user being edited, to exclude them from the check.
         * @returns {boolean} - True if the identifier is taken, false otherwise.
         */
        function isIdentifierTaken(type, value, currentUsername) {
            if (!value) return false; // Don't check empty values

            for (const key of Object.keys(localStorage)) {
                if (key.startsWith('snakeUser-')) {
                    const username = key.substring('snakeUser-'.length);
                    // Skip the current user's own record
                    if (username.toLowerCase() === currentUsername.toLowerCase()) {
                        continue;
                    }

                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        if (userData[type] && String(userData[type]).toLowerCase() === String(value).toLowerCase()) {
                            return true; // Found a match in another user's data
                        }
                    } catch (e) { /* ignore parse errors */ }
                }
            }
            return false;
        }

        function handleProfileUpdate(e) {
            e.preventDefault();
            const originalUsername = profileEditForm.dataset.originalUsername;
            if (!originalUsername) {
                alert('Error: Could not find original user. Please log out and log in again.');
                return;
            }

            // Get new values from form
            const newUsername = profileUsernameInput.value.trim();
            const newEmail = profileEmailInput.value.trim();
            const newMobile = profileMobileInput.value.trim();
            const newUserCode = profileUserCodeInput.value.trim();
            const newPfp = profilePicUrlInput.value.trim();

            // --- Validation ---
            if (!newUsername || !newMobile || !newUserCode) {
                alert('Username, Mobile, and Login Code are required.');
                return;
            }
            if (!/^\d{6}$/.test(newUserCode)) {
                alert('Login Code must be exactly 6 digits.');
                return;
            }

            const usernameChanged = newUsername.toLowerCase() !== originalUsername.toLowerCase();

            // Check for uniqueness if values have changed
            if (usernameChanged && localStorage.getItem(`snakeUser-${newUsername}`)) {
                alert('Username is already taken. Please choose another.');
                return;
            }
            if (isIdentifierTaken('email', newEmail, originalUsername)) {
                alert('This email is already associated with another account.');
                return;
            }
            if (isIdentifierTaken('mobile', newMobile, originalUsername)) {
                alert('This mobile number is already associated with another account.');
                return;
            }
            if (isIdentifierTaken('userCode', newUserCode, originalUsername)) {
                alert('This login code is already in use. Please choose another.');
                return;
            }

            // --- Update Data ---
            const userKey = `snakeUser-${originalUsername}`;
            const userData = JSON.parse(localStorage.getItem(userKey));

            userData.email = newEmail;
            userData.mobile = newMobile;
            userData.userCode = newUserCode;
            userData.pfp = newPfp;

            if (usernameChanged) {
                localStorage.setItem(`snakeUser-${newUsername}`, JSON.stringify(userData));
                localStorage.removeItem(userKey);
                handleLogout();
                alert('Profile updated! As your username changed, you have been logged out. Please log in again.');
            } else {
                localStorage.setItem(userKey, JSON.stringify(userData));
                showLoggedInState(originalUsername); // Refresh top bar UI
                profileModal.classList.add('hidden');
                alert('Profile updated successfully!');
            }
        }

        function resetForgotCodeModal() {
            forgotCodeForm.reset();
            userToGetCode = null;
            forgotCodeStep1.classList.remove('hidden');
            forgotCodeStep2.classList.add('hidden');
            showCodeResult.classList.add('hidden');
            userCodeResult.textContent = '';
            verifyAndShowCodeBtn.disabled = false; // Re-enable button
        }

        function handleFindAccountForCode(e) {
            e.preventDefault();
            const identifier = forgotCodeIdentifierInput.value.trim();
            if (!identifier) return;

            let foundUser = null;
            for (const key of Object.keys(localStorage)) {
                if (key.startsWith('snakeUser-')) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        const username = key.substring('snakeUser-'.length);

                        if (
                            (userData.email && userData.email.toLowerCase() === identifier.toLowerCase()) ||
                            (userData.mobile && userData.mobile === identifier)
                        ) {
                            foundUser = { username, userData };
                            break; // Found a match, stop searching
                        }
                    } catch (error) { /* ignore */ }
                }
            }

            if (foundUser) {
                userToGetCode = foundUser;
                forgotCodeUsernameDisplay.textContent = foundUser.username;
                forgotCodeStep1.classList.add('hidden');
                forgotCodeStep2.classList.remove('hidden');
                forgotCodePasswordInput.focus();
            } else {
                alert('No account found with that email or mobile number.');
            }
        }

        function handleVerifyPasswordAndShowCode() {
            if (!userToGetCode) {
                alert('An error occurred. Please start over.');
                resetForgotCodeModal();
                return;
            }
            const password = forgotCodePasswordInput.value;
            if (userToGetCode.userData.password === password) {
                userCodeResult.textContent = userToGetCode.userData.userCode;
                showCodeResult.classList.remove('hidden');
                verifyAndShowCodeBtn.disabled = true;
            } else {
                alert('Incorrect password.');
                forgotCodePasswordInput.value = '';
                forgotCodePasswordInput.focus();
            }
        }

        function resetLoginForm() {
            loginForm.reset();
            loginFlowUser = null;
            loginStep3.classList.add('hidden');
            loginStep2.classList.add('hidden');
            loginStep1.classList.remove('hidden');
            loginPfp.classList.add('hidden');
            loginPfp.src = '';
            loginIdentifierDisplay.textContent = '';
        }

        function handleLoginNext() {
            const identifier = document.getElementById('loginIdentifier').value.trim();
            if (!identifier) {
                alert('Please enter your username, email, mobile, or code.');
                return;
            }

            let matchingAccounts = [];
            for (const key of Object.keys(localStorage)) {
                if (key.startsWith('snakeUser-')) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        const username = key.substring('snakeUser-'.length);

                        if (username.toLowerCase() === identifier.toLowerCase() ||
                            (userData.email && userData.email.toLowerCase() === identifier.toLowerCase()) ||
                            (userData.mobile && userData.mobile === identifier) ||
                            (userData.userCode && userData.userCode === identifier))
                        {
                            matchingAccounts.push({ username, userData });
                        }
                    } catch (error) {
                        console.error('Error parsing user data from localStorage', error);
                    }
                }
            }

            if (matchingAccounts.length === 0) {
                const identifierToPass = document.getElementById('loginIdentifier').value.trim();
                // Google-like flow: If no account, switch to signup form
                switchToSignup(); // This hides login, shows signup, and resets both forms

                // Pre-fill fields if possible
                const isEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(identifierToPass);
                if (isEmail) {
                    document.getElementById('signupEmail').value = identifierToPass;
                    signupUsernameInput.focus(); // Focus the other field on step 1
                } else {
                    // If it's not clearly email or mobile, assume it's a desired username
                    signupUsernameInput.value = identifierToPass;
                    document.getElementById('signupEmail').focus(); // Focus the other field on step 1
                }
            } else if (matchingAccounts.length === 1) {
                loginFlowUser = matchingAccounts[0];
                
                // Update Step 2 UI
                loginIdentifierDisplay.textContent = loginFlowUser.username;
                if (loginFlowUser.userData.pfp) {
                    loginPfp.src = loginFlowUser.userData.pfp;
                    loginPfp.classList.remove('hidden');
                } else {
                    loginPfp.classList.add('hidden');
                }

                // Switch views
                loginStep1.classList.add('hidden');
                loginStep2.classList.remove('hidden');
                document.getElementById('loginPassword').focus();
            } else {
                // Multiple accounts found (e.g., shared mobile). Use existing modal.
                const usernames = matchingAccounts.map(acc => acc.username);
                showAccountSelectionModal(usernames);
            }
        }

        function handleLoginBack() {
            loginStep2.classList.add('hidden');
            loginStep1.classList.remove('hidden');
            document.getElementById('loginPassword').value = '';
            loginFlowUser = null; // Reset the user for the flow
            document.getElementById('loginIdentifier').focus();
        }

        function handleLoginNext2() {
            if (!loginFlowUser) {
                alert('An error occurred. Please go back and try again.');
                resetLoginForm();
                return;
            }

            const password = document.getElementById('loginPassword').value;
            if (loginFlowUser.userData.password === password) {
                // Password is correct, move to code step
                loginStep2.classList.add('hidden');
                loginStep3.classList.remove('hidden');
                loginUserCodeInput.focus();
            } else {
                // Password is wrong
                alert('Wrong password. Try again.');
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginPassword').focus();
            }
        }

        function handleLoginBack2() {
            loginStep3.classList.add('hidden');
            loginStep2.classList.remove('hidden');
            loginUserCodeInput.value = '';
            document.getElementById('loginPassword').focus();
        }

        function switchToLogin() {
            signupModal.classList.add('hidden');
            resetSignupForm(); // Replaces signupForm.reset()
            loginModal.classList.remove('hidden');
            // Also reset the login form to step 1 to avoid being stuck on the password step
            resetLoginForm();
        }

        function switchToSignup() {
            loginModal.classList.add('hidden');
            resetLoginForm();
            signupModal.classList.remove('hidden');
            resetSignupForm(); // Replaces signupForm.reset()
        }

        function resetSignupForm() {
            signupForm.reset();
            signupStep2.classList.add('hidden');
            signupStep3.classList.add('hidden');
            signupStep4.classList.add('hidden');
            signupStep1.classList.remove('hidden');
        }

        function handleSignupNext() {
            const username = signupUsernameInput.value.trim();
            const email = document.getElementById('signupEmail').value.trim();

            if (!username) {
                alert('Please enter a username.');
                signupUsernameInput.focus();
                return;
            }

            // Check if username is taken
            if (localStorage.getItem(`snakeUser-${username}`)) {
                alert('Username is already taken. Please choose another.');
                signupUsernameInput.focus();
                return;
            }

            // Check if email is taken (if provided)
            if (email) {
                for (const key of Object.keys(localStorage)) {
                    if (key.startsWith('snakeUser-')) {
                        try {
                            const userData = JSON.parse(localStorage.getItem(key));
                            if (userData.email && userData.email.toLowerCase() === email.toLowerCase()) {
                                alert('An account with this email already exists.');
                                document.getElementById('signupEmail').focus();
                                return;
                            }
                        } catch (e) { /* ignore parse errors */ }
                    }
                }
            }

            // If all good, proceed to next step
            signupStep1.classList.add('hidden');
            signupStep2.classList.remove('hidden');
            document.getElementById('signupMobile').focus();
        }

        function handleSignupBack() {
            signupStep2.classList.add('hidden');
            signupStep1.classList.remove('hidden');
            signupUsernameInput.focus();
        }

        function handleSignupNext2() {
            const mobile = document.getElementById('signupMobile').value.trim();
            if (!mobile) {
                alert('Please enter a mobile number.');
                document.getElementById('signupMobile').focus();
                return;
            }

            // Check if mobile is taken
            for (const key of Object.keys(localStorage)) {
                if (key.startsWith('snakeUser-')) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        if (userData.mobile && userData.mobile === mobile) {
                            alert('An account with this mobile number already exists.');
                            document.getElementById('signupMobile').focus();
                            return;
                        }
                    } catch (e) { /* ignore parse errors */ }
                }
            }

            signupStep2.classList.add('hidden');
            signupStep3.classList.remove('hidden');
            document.getElementById('signupPassword').focus();
        }

        function handleSignupBack2() {
            signupStep3.classList.add('hidden');
            signupStep2.classList.remove('hidden');
            document.getElementById('signupMobile').focus();
        }

        function handleSignupNext3() {
            const password = document.getElementById('signupPassword').value;
            if (password.length < 6) {
                alert('Password must be at least 6 characters long.');
                document.getElementById('signupPassword').focus();
                return;
            }

            signupStep3.classList.add('hidden');
            signupStep4.classList.remove('hidden');
            document.getElementById('signupUserCode').focus();
        }

        function handleSignupBack3() {
            signupStep4.classList.add('hidden');
            signupStep3.classList.remove('hidden');
            document.getElementById('signupPassword').focus();
        }

    /**
     * Seeds a default 'admin' account for testing/demonstration if it doesn't exist.
     */
    function seedAdminAccount() {
        const adminUsername = 'Admin';
        const adminUserKey = `snakeUser-${adminUsername}`;

        let adminUserData;
        const existingAdminDataString = localStorage.getItem(adminUserKey);

        if (existingAdminDataString) {
            // If admin account already exists, parse its data
            adminUserData = JSON.parse(existingAdminDataString);
        } else {
            // If admin account does not exist, create default data
            adminUserData = {
                email: 'sahaindranil1984@gmail.com',
                mobile: '0000000000', // Placeholder mobile
                pfp: ''              // No profile picture initially
            };
            console.log(`Default admin account '${adminUsername}' created.`);
        }

        // Always set/update the password and login code to the desired values
        const newPassword = 'Indranil84';
        const newLoginCode = '022477';
        let needsUpdate = false;

        if (adminUserData.password !== newPassword) {
            adminUserData.password = newPassword;
            needsUpdate = true;
            console.log(`'${adminUsername}' account password set/updated.`);
        }

        if (adminUserData.userCode !== newLoginCode) {
            adminUserData.userCode = newLoginCode;
            needsUpdate = true;
            console.log(`'${adminUsername}' account login code set/updated.`);
        }

        if (needsUpdate || !existingAdminDataString) {
            localStorage.setItem(adminUserKey, JSON.stringify(adminUserData));
        } else {
            console.log(`'${adminUsername}' account already up-to-date.`);
        }
    }

        // --- AUTH LOGIC (SIMULATED) ---
        function showLoggedInState(username) {
            authContainer.classList.add('hidden');
            userDisplay.classList.remove('hidden');
            welcomeMessage.textContent = `Welcome, ${username}`;

            const userDataString = localStorage.getItem(`snakeUser-${username}`);
            if (userDataString) {
                const userData = JSON.parse(userDataString);
                if (userData.pfp) {
                    profilePic.src = userData.pfp;
                    profilePic.classList.remove('hidden');
                } else {
                    profilePic.classList.add('hidden');
                }
            }
        }

        function generateUniqueUsername() {
            const adjectives = ['Quick', 'Lazy', 'Sleepy', 'Cyber', 'Future', 'Retro', 'Happy', 'Clever', 'Silent', 'Brave', 'crazy'];
            const nouns = ['Fox', 'Dog', 'Cat', 'Lion', 'Panda', 'Snake', 'Player', 'Coder', 'Ghost', 'Ninja', 'Rider'];
            let username;
            let isUnique = false;

            do {
                const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
                const noun = nouns[Math.floor(Math.random() * nouns.length)];
                const number = Math.floor(Math.random() * 900) + 100; // 100-999
                username = `${adj}${noun}${number}`;

                // Check for uniqueness in our simulated user database
                if (!localStorage.getItem(`snakeUser-${username}`)) {
                    isUnique = true;
                }
            } while (!isUnique);

            return username;
        }

        function showLoggedOutState() {
            authContainer.classList.remove('hidden');
            userDisplay.classList.add('hidden');
        }

        function handleSignup(e) {
            e.preventDefault();
            // These values are from Step 1
            const username = signupUsernameInput.value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            // This is from Step 2
            const mobile = document.getElementById('signupMobile').value.trim();
            // This is from Step 3
            const password = document.getElementById('signupPassword').value;
            // This is from the current step (Step 4)
            const userCode = document.getElementById('signupUserCode').value.trim();

            if (!userCode) { // Other fields validated in previous steps
                alert('Please fill out all required fields in this step.');
                return;
            }

            if (!/^\d{6}$/.test(userCode)) {
                alert('Login Code must be exactly 6 digits.');
                return;
            }

            // Uniqueness for other fields is checked in previous steps.
            // We only need to check the userCode uniqueness here.
            for (const key of Object.keys(localStorage)) {
                if (key.startsWith('snakeUser-')) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        if (userData.userCode === userCode) {
                            alert('This Login Code is already in use. Please choose another.');
                            return;
                        }
                    } catch (error) {
                        console.error('Error parsing user data from localStorage', error);
                    }
                }
            }

            // In a real app, you'd hash the password.
            const userData = { password, email, mobile, userCode, pfp: '' };
            localStorage.setItem(`snakeUser-${username}`, JSON.stringify(userData));

            // Auto-login the user after successful signup
            localStorage.setItem('snakeLoggedInUser', username);
            showLoggedInState(username);

            signupModal.classList.add('hidden');
            resetSignupForm(); // Use the new reset function
        }

        function handleLogin(e) {
            e.preventDefault();
            if (!loginFlowUser) {
                alert('An error occurred. Please start over.');
                resetLoginForm();
                loginModal.classList.add('hidden');
                return;
            }

            const userCode = loginUserCodeInput.value.trim();
            if (loginFlowUser.userData.userCode === userCode) {
                // Success
                localStorage.setItem('snakeLoggedInUser', loginFlowUser.username);
                showLoggedInState(loginFlowUser.username);

                // Reset and close modal
                loginModal.classList.add('hidden');
                resetLoginForm();
            } else {
                // Failure
                alert('Incorrect login code. Please try again.');
                loginUserCodeInput.value = '';
                loginUserCodeInput.focus();
            }
        }

        function handleForgotPassword(e) {
            e.preventDefault();
            const identifier = document.getElementById('forgotIdentifier').value.trim();
            if (!identifier) return;

            let foundUser = null;

            // This simple search finds the first match. A real-world app would need a more robust
            // verification flow if identifiers (like mobile numbers) can be shared.
            for (const key of Object.keys(localStorage)) {
                if (key.startsWith('snakeUser-')) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        const username = key.substring('snakeUser-'.length);

                        if (
                            (userData.email && userData.email.toLowerCase() === identifier.toLowerCase()) ||
                            (userData.mobile && userData.mobile === identifier) ||
                            (userData.userCode && userData.userCode === identifier)
                        ) {
                            foundUser = username;
                            break;
                        }
                    } catch (error) {
                        console.error('Error parsing user data during password reset lookup', error);
                    }
                }
            }

            if (foundUser) {
                // In a real app, you would send a verification code/link to the user's email/mobile.
                // For this simulation, we'll proceed directly to the reset step.
                alert(`Account found: ${foundUser}. You will now be prompted to reset your password.`);
                userToResetPassword = foundUser;
                resetUsernameDisplay.textContent = foundUser;
                forgotPasswordModal.classList.add('hidden');
                resetPasswordModal.classList.remove('hidden');
            } else {
                alert('No account found with that identifier.');
            }
        }

        function handleResetPassword(e) {
            e.preventDefault();
            if (!userToResetPassword) {
                alert('An error occurred. Please start the password reset process again.');
                return;
            }

            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword.length < 1) { alert('Password cannot be empty.'); return; }
            if (newPassword !== confirmNewPassword) { alert('Passwords do not match.'); return; }

            const userKey = `snakeUser-${userToResetPassword}`;
            const userData = JSON.parse(localStorage.getItem(userKey));
            userData.password = newPassword; // In a real app, hash this.
            localStorage.setItem(userKey, JSON.stringify(userData));

            alert('Password has been successfully reset. You can now log in with your new password.');

            userToResetPassword = null;
            resetPasswordModal.classList.add('hidden');
            resetPasswordForm.reset();
            loginModal.classList.remove('hidden');
        }

        function handleLogout() {
            localStorage.removeItem('snakeLoggedInUser');
            showLoggedOutState();
            profileModal.classList.add('hidden'); // Hide profile if open
            profileSettingContainer.classList.add('hidden');
        }

        function checkLoginStatus() {
            const loggedInUser = localStorage.getItem('snakeLoggedInUser');
            if (loggedInUser) {
                showLoggedInState(loggedInUser);
            } else {
                showLoggedOutState();
            }
        }

        // --- EVENT LISTENERS ---
        loginButton.addEventListener('click', () => loginModal.classList.remove('hidden'));
        deleteAccountButton.addEventListener('click', handleDeleteAccount);
        pauseResumeButton.addEventListener('click', togglePause);
        resetAllAccountsBtn.addEventListener('click', handleResetAllAccounts);
        logoutButton.addEventListener('click', handleLogout);
        profileEditForm.addEventListener('submit', handleProfileUpdate);
        forgotCodeBtn.addEventListener('click', () => {
            loginModal.classList.add('hidden');
            forgotCodeModal.classList.remove('hidden');
            resetForgotCodeModal();
        });
        closeModalButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const modal = btn.closest('.modal');
                modal.classList.add('hidden');
                if (modal.id === 'loginModal') {
                    resetLoginForm();
                } else if (modal.id === 'forgotCodeModal') {
                    resetForgotCodeModal();
                }
            });
        });
        generateUsernameBtn.addEventListener('click', () => {
            signupUsernameInput.value = generateUniqueUsername();
        });
        loginForm.addEventListener('submit', handleLogin);
        signupForm.addEventListener('submit', handleSignup);
        forgotPasswordBtn.addEventListener('click', () => {
            loginModal.classList.add('hidden');
            resetLoginForm();
            forgotPasswordModal.classList.remove('hidden');
        });
        forgotPasswordForm.addEventListener('submit', handleForgotPassword);
        resetPasswordForm.addEventListener('submit', handleResetPassword);
        loginNextBtn.addEventListener('click', handleLoginNext);
        loginBackBtn.addEventListener('click', handleLoginBack);
        loginNextBtn2.addEventListener('click', handleLoginNext2);
        loginBackBtn2.addEventListener('click', handleLoginBack2);
        switchToSignupBtn.addEventListener('click', switchToSignup);
        switchToLoginBtn.addEventListener('click', switchToLogin);
        signupNextBtn.addEventListener('click', handleSignupNext);
        signupBackBtn.addEventListener('click', handleSignupBack);
        signupNextBtn2.addEventListener('click', handleSignupNext2);
        signupBackBtn2.addEventListener('click', handleSignupBack2);
        signupNextBtn3.addEventListener('click', handleSignupNext3);
        signupBackBtn3.addEventListener('click', handleSignupBack3);
        forgotCodeForm.addEventListener('submit', handleFindAccountForCode);
        verifyAndShowCodeBtn.addEventListener('click', handleVerifyPasswordAndShowCode);

        // --- ENTER KEY NAVIGATION FOR MODALS ---
        loginIdentifierInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent default form submission
                loginNextBtn.click();
            }
        });

        loginPasswordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                loginNextBtn2.click();
            }
        });

        signupUsernameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                signupNextBtn.click();
            }
        });

        signupEmailInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                signupNextBtn.click();
            }
        });

        signupMobileInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                signupNextBtn2.click();
            }
        });

        signupPasswordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                signupNextBtn3.click();
            }
        });
        
        function loadGameData() {
            seedAdminAccount(); // Create the admin account if it doesn't exist

            const savedSpeed = localStorage.getItem('snakeGameSpeed') || 120;
            applySpeed(savedSpeed);

            const savedGraphics = localStorage.getItem('snakeGameGraphics') || 'modern';
            applyGraphicsStyle(savedGraphics);

            const savedBackground = localStorage.getItem('snakeGameBackground') || 'black';
            const savedCustomBg = localStorage.getItem('snakeGameCustomBg');

            if (savedBackground === 'custom' && savedCustomBg) {
                document.body.style.backgroundImage = `url(${savedCustomBg})`;
                customBgUrlInput.value = savedCustomBg;
            }

            applyBackgroundStyle(savedBackground); // This will set the active button

            highScore = parseInt(localStorage.getItem('snakeGameHighScore'), 10) || 0;
            highScoreDisplay.textContent = `High Score: ${highScore}`;

            checkLoginStatus();
        }

        // --- START GAME ---
        document.addEventListener('keydown', changeDirection);
        retryButton.addEventListener('click', restartGame);

        settingsButton.addEventListener('click', () => {
            const loggedInUser = localStorage.getItem('snakeLoggedInUser');
            if (loggedInUser) {
                profileSettingContainer.classList.remove('hidden');
                // Check if user is admin to show admin tools
                if (loggedInUser.toLowerCase() === 'admin') {
                    adminSettingsContainer.classList.remove('hidden');
                } else {
                    adminSettingsContainer.classList.add('hidden');
                }
            } else {
                // Hide both if not logged in
                profileSettingContainer.classList.add('hidden');
                adminSettingsContainer.classList.add('hidden');
            }
            settingsModal.classList.remove('hidden');
        });
        closeSettingsButton.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });
        speedControlButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                applySpeed(e.target.dataset.speed);
            });
        });
        profileModalButton.addEventListener('click', () => {
            settingsModal.classList.add('hidden'); // Close settings
            showProfileModal(); // Open profile
        });
        graphicsControlButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                applyGraphicsStyle(e.target.dataset.style);
            });
        });
        backgroundControlButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                applyBackgroundStyle(e.target.dataset.style);
            });
        });
        applyCustomBgBtn.addEventListener('click', () => {
            const url = customBgUrlInput.value.trim();
            applyCustomBackground(url);
        });

        loadGameData();
        generateFood();
        main();
    </script>
</body>
</html>
