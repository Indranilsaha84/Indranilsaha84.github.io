<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comment Box</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            color: #1f2937;
        }

        /* Glassmorphism effect for the main container */
        .glassmorphic-box {
            background-color: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Gradient border for inputs on focus */
        .gradient-border-focus:focus {
            outline: none;
            border-color: transparent;
            box-shadow: 0 0 0 4px rgba(76, 81, 191, 0.5);
            transition: box-shadow 0.3s ease-in-out;
        }

        /* Animation for a smooth fade-in and slide-up effect on comments */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fadeInUp {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        /* Animation for the "Add Comment" button */
        @keyframes pulse {
            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.025);
            }
        }

        .animate-pulse-once {
            animation: pulse 1s cubic-bezier(0.4, 0, 0.6, 1);
        }

        /* Gradient and shadow for the button */
        .gradient-button {
            background-image: linear-gradient(to right, #4c51bf, #6b46c1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .gradient-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Style for individual comment cards */
        .comment-card {
            background-color: rgba(255, 255, 255, 0.8);
            border-left: 4px solid #4c51bf;
        }

        /* Style for the summary section */
        .summary-box {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border: 1px solid rgba(76, 81, 191, 0.5);
        }
    </style>
</head>

<body class="p-4 md:p-8 flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 to-purple-200">
    <div class="max-w-3xl w-full">
        <!-- Main Container -->
        <div class="glassmorphic-box p-6 md:p-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-center mb-2 text-gray-900" style="font-family: 'Montserrat', sans-serif;">
                Comment Box
            </h1>
            <p class="text-center text-gray-700 mb-8">
                A stylish demo of a web-based comment section with a real-time database.
            </p>

            <!-- User ID Display -->
            <div id="user-info" class="text-center text-sm text-gray-600 mb-6 hidden">
                Your User ID: <span id="user-id" class="font-mono bg-gray-100 p-1 rounded-md"></span>
            </div>

            <!-- Comment Form -->
            <form id="comment-form" class="space-y-4 mb-8">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="name" name="name" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg gradient-border-focus transition duration-150 ease-in-out"
                        placeholder="Your name">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email (Optional)</label>
                    <input type="email" id="email" name="email"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg gradient-border-focus transition duration-150 ease-in-out"
                        placeholder="your@email.com">
                </div>
                <div>
                    <label for="comment" class="block text-sm font-medium text-gray-700 mb-1">Comment</label>
                    <textarea id="comment" name="comment" required rows="4"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg gradient-border-focus transition duration-150 ease-in-out"
                        placeholder="Write your comment here..."></textarea>
                </div>
                <button type="submit"
                    class="w-full text-white font-semibold py-2 px-4 rounded-lg focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 gradient-button">
                    Add Comment
                </button>
            </form>

            <!-- Comments Section -->
            <div class="space-y-6">
                <div id="comments-list" class="space-y-4">
                    <!-- Comments will be rendered here -->
                </div>

                <div class="mt-8 flex justify-center">
                    <button id="summarize-button"
                        class="text-white font-semibold py-2 px-6 rounded-full focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 gradient-button">
                        ✨ Summarize Comments
                    </button>
                </div>

                <!-- Summary Section -->
                <div id="summary-container" class="mt-6 hidden">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">Conversation Summary</h3>
                    <div id="summary-text" class="summary-box p-4">
                        <!-- Summary will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Loading/Info Message -->
            <div id="status-message" class="text-center text-gray-500 mt-6">
                Loading comments...
            </div>
        </div>

        <!-- Custom Modal for Alerts -->
        <div id="custom-modal"
            class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <div class="text-lg font-bold mb-4" id="modal-title"></div>
                <p class="text-sm text-gray-600 mb-6" id="modal-message"></p>
                <div class="flex justify-end">
                    <button id="modal-ok-button"
                        class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150 ease-in-out">OK</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs and Gemini API call -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase services
        let app;
        let db;
        let auth;
        let userId = null;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // UI elements
        const commentForm = document.getElementById('comment-form');
        const commentsList = document.getElementById('comments-list');
        const statusMessage = document.getElementById('status-message');
        const userIdDisplay = document.getElementById('user-id');
        const userInfoContainer = document.getElementById('user-info');
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalOkButton = document.getElementById('modal-ok-button');
        const summarizeButton = document.getElementById('summarize-button');
        const summaryContainer = document.getElementById('summary-container');
        const summaryText = document.getElementById('summary-text');

        /**
         * Custom modal function to replace alert().
         * @param {string} title - The title of the modal.
         * @param {string} message - The message to display.
         */
        function showCustomModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        // Handle modal close
        modalOkButton.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // Initialize Firebase and set up authentication
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }

                    userId = auth.currentUser?.uid;
                    if (userId) {
                        userIdDisplay.textContent = userId;
                        userInfoContainer.classList.remove('hidden');
                    }
                    console.log("Firebase initialized successfully. User is authenticated.");
                    setupRealtimeComments();
                } else {
                    statusMessage.textContent = "Firebase configuration is missing. Please check your setup.";
                }
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showCustomModal("Error", "Failed to initialize the application. Please check the console for details.");
            }
        }

        // Set up real-time listener for comments
        function setupRealtimeComments() {
            if (!db) {
                console.error("Firestore database is not initialized.");
                return;
            }

            const commentsCollectionRef = collection(db, `artifacts/${appId}/public/data/comments`);
            const commentsQuery = query(commentsCollectionRef);

            onSnapshot(commentsQuery, (snapshot) => {
                const currentCommentIds = Array.from(commentsList.children).map(el => el.dataset.commentId);
                const newCommentIds = new Set(snapshot.docChanges().filter(change => change.type === 'added').map(change => change.doc.id));

                commentsList.innerHTML = '';
                let comments = [];
                snapshot.forEach(doc => {
                    comments.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                comments.sort((a, b) => (a.timestamp ? a.timestamp.toDate() : 0) - (b.timestamp ? b.timestamp.toDate() : 0));

                if (comments.length === 0) {
                    statusMessage.textContent = "No comments yet. Be the first to add one!";
                    summarizeButton.disabled = true;
                    summaryContainer.classList.add('hidden');
                } else {
                    statusMessage.textContent = "";
                    summarizeButton.disabled = false;
                    comments.forEach(comment => {
                        renderComment(comment, newCommentIds.has(comment.id));
                    });
                }
            }, (error) => {
                console.error("Error fetching comments:", error);
                showCustomModal("Error", "Could not load comments. Please check your network connection.");
            });
        }

        // Render a single comment to the DOM with animation based on isNew
        function renderComment(commentData, isNew = false) {
            const commentElement = document.createElement('div');
            commentElement.className = "p-4 rounded-lg comment-card";
            if (isNew) {
                commentElement.classList.add('animate-fadeInUp');
            }
            commentElement.dataset.commentId = commentData.id;
            const date = commentData.timestamp ? commentData.timestamp.toDate() : new Date();
            const formattedDate = date.toLocaleString();

            commentElement.innerHTML = `
                <div class="flex items-baseline mb-1">
                    <p class="font-bold text-sm text-gray-800">${commentData.name}</p>
                    <p class="text-xs text-gray-400 ml-2">${formattedDate}</p>
                </div>
                <p class="text-gray-700">${commentData.comment}</p>
            `;
            commentsList.appendChild(commentElement);
        }

        // Handle form submission
        commentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db) {
                showCustomModal("Error", "Application is not initialized. Please try again later.");
                return;
            }

            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const comment = document.getElementById('comment').value;

            if (!name || !comment) {
                showCustomModal("Validation Error", "Please fill in all fields.");
                return;
            }

            const submitButton = commentForm.querySelector('button[type="submit"]');
            submitButton.classList.add('animate-pulse-once');

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/comments`), {
                    name,
                    email,
                    comment,
                    timestamp: serverTimestamp(),
                    userId
                });
                console.log("Comment added successfully.");
                commentForm.reset();
            } catch (error) {
                console.error("Error adding comment:", error);
                showCustomModal("Error", "Failed to add your comment. Please try again.");
            } finally {
                // Remove the animation class after it's done
                setTimeout(() => {
                    submitButton.classList.remove('animate-pulse-once');
                }, 1000);
            }
        });

        // Gemini API integration for summarizing comments
        summarizeButton.addEventListener('click', async () => {
            const comments = Array.from(commentsList.children).map(el => {
                const name = el.querySelector('.font-bold').textContent;
                const commentText = el.querySelector('p:not(.font-bold)').textContent;
                return `${name}: ${commentText}`;
            }).join('\n');

            if (comments.trim() === "") {
                showCustomModal("No Comments", "There are no comments to summarize.");
                return;
            }

            summarizeButton.disabled = true;
            summarizeButton.textContent = "Summarizing...";
            summaryContainer.classList.remove('hidden');
            summaryText.innerHTML = `<p class="text-gray-500">Generating summary...</p>`;

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    parts: [{
                        text: `Please summarize the following comments concisely:\n\n${comments}`
                    }]
                }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                const summary = result.candidates[0].content.parts[0].text;
                summaryText.innerHTML = `<p>${summary}</p>`;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                summaryText.innerHTML = `<p class="text-red-500">Failed to generate summary. Please try again later.</p>`;
            } finally {
                summarizeButton.disabled = false;
                summarizeButton.textContent = "✨ Summarize Comments";
            }
        });


        // Start the application
        initializeFirebase();
    </script>
</body>

</html>